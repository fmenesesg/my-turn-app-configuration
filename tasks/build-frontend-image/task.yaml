apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: build-frontend-image
spec:
  inputs:
    params:
      - description: git url to clone
        name: url
        type: string
      - default: master
        description: 'git revision to checkout (branch, tag, sha, refâ€¦)'
        name: revision
        type: string
  steps:
    - image: 'quay.io/rshop/toolchain-cli-alpine:master'
      name: clone-code
      resources: {}
      script: >
        #!/usr/bin/env sh

        git clone --branch "$(inputs.params.revision)" "$(inputs.params.url)"
        /src/tmp-code

        cp -r /src/tmp-code/* /src/my-turn-app

        cd /src/tmp-code/

        git show-branch --current

        tree -L 1 /src/my-turn-app/frontend
      volumeMounts:
        - mountPath: /src
          name: source-code
    - image: 'quay.io/rshop/toolchain-cli-alpine:latest'
      name: get-backend-url
      resources: {}
      script: >
        #!/usr/bin/env sh

        cd /src/my-turn-app/frontend

        export PROTOCOLO=`if [ "$(oc get route backend -o jsonpath='{
        .spec.tls.termination }')" != "" ]; then echo "https"; else echo "http";
        fi`

        echo "VUE_APP_API_URL=$PROTOCOLO://$(oc get route backend -o jsonpath='{
        .spec.host }')" | tee .env.local
      volumeMounts:
        - mountPath: /src
          name: source-code
    - image: 'quay.io/rshop/npm-alpine:master'
      name: test-lint-and-build
      resources: {}
      script: |
        #!/usr/bin/env sh
        cd /src/my-turn-app/frontend
        npm install
        npm run test:unit
        npm run lint
        npm run build
      volumeMounts:
        - mountPath: /src
          name: source-code
    - args:
        - '--dockerfile=/src/my-turn-app/frontend/Dockerfile'
        - '--context=dir:///src/my-turn-app/frontend'
        - '--destination=quay.io/rshop/my-turn-app-frontend:develop'
      image: 'gcr.io/kaniko-project/executor:latest'
      name: generate-and-push-image
      resources: {}
      securityContext:
        runAsUser: 0
      volumeMounts:
        - mountPath: /kaniko/.docker
          name: docker-config-volume
        - mountPath: /root/.docker
          name: docker-config-volume
        - mountPath: /src
          name: source-code
  volumes:
    - emptyDir: {}
      name: source-code
    - name: docker-config-volume
      secret:
        secretName: rshop-registry-auth
  workspaces:
    - description: The node packages needed for this app
      mountPath: /src/my-turn-app/frontend/node_modules
      name: npm-modules
